# ============================================================================
# ADD THIS TO YOUR EXISTING predictionapi.gahfaudio.in vhconf.conf
# Add these sections AFTER the existing extprocessor predi3169 section
# ============================================================================

# FastAPI Backend Proxy
extprocessor fastapi_backend {
  type                    proxy
  address                 127.0.0.1:8023
  maxConns                100
  pcKeepAliveTimeout      60
  initTimeout             60
  retryTimeout            0
  respBuffer              0
}

# WebSocket Proxy (same backend, for WS connections)
extprocessor websocket_backend {
  type                    proxy
  address                 127.0.0.1:8023
  maxConns                100
  pcKeepAliveTimeout      300
  initTimeout             60
  retryTimeout            0
  respBuffer              0
}

# Proxy all API requests to FastAPI
context / {
  type                    proxy
  handler                 fastapi_backend
  addDefaultCharset       off
}

# WebSocket context for real-time updates
context /ws {
  type                    proxy
  handler                 websocket_backend
  addDefaultCharset       off
}

# ============================================================================
# ALSO UPDATE THE rewrite SECTION - Replace your existing rewrite block with:
# ============================================================================

rewrite  {
  enable                  1
  autoLoadHtaccess        1
  rules                   <<<END_RULES
# Enable rewrite engine
RewriteEngine On

# Proxy WebSocket connections
RewriteCond %{HTTP:Upgrade} websocket [NC]
RewriteCond %{HTTP:Connection} upgrade [NC]
RewriteRule ^/ws/(.*)$ ws://127.0.0.1:8023/ws/$1 [P,L]

# Proxy all other requests to FastAPI
RewriteRule ^(.*)$ http://127.0.0.1:8023$1 [P,L]
END_RULES
}
