# OpenLiteSpeed vhost configuration for predictionapi.gahfaudio.in
# Copy this to: /usr/local/lsws/conf/vhosts/predictionapi.gahfaudio.in/vhconf.conf
# Or add via CyberPanel -> Websites -> predictionapi.gahfaudio.in -> vHost Conf

# Document Root
docRoot                   /home/predictionapi.gahfaudio.in/public_html

# Enable access log
accesslog /home/predictionapi.gahfaudio.in/logs/access.log {
  useServer               0
  logFormat               "%h %l %u %t \"%r\" %>s %b"
  logHeaders              5
  rollingSize             10M
  keepDays                30
}

# Error log
errorlog /home/predictionapi.gahfaudio.in/logs/error.log {
  useServer               0
  logLevel                WARN
  rollingSize             10M
  keepDays                30
}

# Rewrite rules for proxy to FastAPI
rewrite  {
  enable                  1
  autoLoadHtaccess        1

  rules                   <<<END_RULES
# Proxy all requests to FastAPI backend running on port 8000
RewriteEngine On

# Health check endpoint
RewriteRule ^/api/v1/health$ http://127.0.0.1:8000/api/v1/health [P,L]

# API endpoints
RewriteRule ^/api/(.*)$ http://127.0.0.1:8000/api/$1 [P,L]

# Docs endpoints
RewriteRule ^/docs$ http://127.0.0.1:8000/docs [P,L]
RewriteRule ^/redoc$ http://127.0.0.1:8000/redoc [P,L]
RewriteRule ^/openapi.json$ http://127.0.0.1:8000/openapi.json [P,L]

# Root endpoint
RewriteRule ^/$ http://127.0.0.1:8000/ [P,L]

# Catch-all for other API requests
RewriteRule ^(.*)$ http://127.0.0.1:8000$1 [P,L]
END_RULES
}

# WebSocket configuration for real-time updates
websocket {
  enable                  1
}

# External app for WebSocket proxy (alternative method)
extprocessor wsbackend {
  type                    proxy
  address                 127.0.0.1:8000
  maxConns                100
  pcKeepAliveTimeout      60
  initTimeout             60
  retryTimeout            0
  respBuffer              0
}

# Context for WebSocket endpoints
context /ws/ {
  type                    proxy
  handler                 wsbackend
  addDefaultCharset       off
}

# Security settings
security {
  accessControl {
    allow                 *
  }
}

# CORS headers (handled by FastAPI, but backup)
context / {
  location                /home/predictionapi.gahfaudio.in/public_html
  allowBrowse             1

  extraHeaders            <<<END_HEADERS
Access-Control-Allow-Origin: https://prediction.gahfaudio.in
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Allow-Credentials: true
END_HEADERS
}
