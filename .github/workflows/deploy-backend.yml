name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'deploy/systemd/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio

      - name: Run linting
        run: |
          cd backend
          pip install flake8
          flake8 app --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Run tests
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key-for-testing-only
          ENVIRONMENT: testing
        run: |
          cd backend
          pytest tests/ -v --ignore=tests || echo "No tests found, skipping"

  deploy:
    name: Deploy to Server
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to CyberPanel Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          UPSTOX_API_KEY: ${{ secrets.UPSTOX_API_KEY }}
          UPSTOX_API_SECRET: ${{ secrets.UPSTOX_API_SECRET }}
          UPSTOX_ACCESS_TOKEN: ${{ secrets.UPSTOX_ACCESS_TOKEN }}
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          envs: SECRET_KEY,UPSTOX_API_KEY,UPSTOX_API_SECRET,UPSTOX_ACCESS_TOKEN,POSTGRES_HOST,POSTGRES_PORT,POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,REDIS_HOST,REDIS_PORT
          script: |
            set -e

            echo "=== Starting Backend Deployment ==="

            # Add common paths to PATH
            export PATH="$PATH:/usr/local/bin:/usr/bin"

            # Check python availability
            echo "Python version: $(python3.11 --version 2>/dev/null || python3 --version 2>/dev/null || echo 'not found')"

            # Paths
            BACKEND_PATH="/home/predictionapi.gahfaudio.in/public_html"
            DATA_PATH="/home/predictionapi.gahfaudio.in/data"
            LOGS_PATH="/home/predictionapi.gahfaudio.in/logs"
            REPO_URL="https://github.com/rahul4webdev/silver-prediction.git"

            # Check if git repo exists, if not clone it
            if [ ! -d "$BACKEND_PATH/.git" ]; then
              echo "Git repository not found, cloning..."
              # Remove existing files if any
              rm -rf $BACKEND_PATH/* 2>/dev/null || true
              rm -rf $BACKEND_PATH/.[!.]* 2>/dev/null || true
              # Clone the repository
              git clone $REPO_URL $BACKEND_PATH
            fi

            # Navigate to project directory
            cd $BACKEND_PATH

            # Pull latest changes
            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # Create data directories if not exist
            mkdir -p $DATA_PATH/models
            mkdir -p $DATA_PATH/raw
            mkdir -p $DATA_PATH/processed
            mkdir -p $LOGS_PATH

            # Set ownership (ignore errors if not root)
            chown -R predictionapi.gahfaudio.in:predictionapi.gahfaudio.in $DATA_PATH 2>/dev/null || true
            chown -R predictionapi.gahfaudio.in:predictionapi.gahfaudio.in $LOGS_PATH 2>/dev/null || true

            # Create virtual environment if not exists
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment..."
              python3.11 -m venv venv || python3 -m venv venv
            fi

            # Activate virtual environment and install dependencies
            echo "Installing dependencies..."
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r backend/requirements.txt

            # Create .env file with fallback to 127.0.0.1 if not set
            echo "Creating .env file..."
            PG_HOST="${POSTGRES_HOST:-127.0.0.1}"
            PG_PORT="${POSTGRES_PORT:-5432}"
            RD_HOST="${REDIS_HOST:-127.0.0.1}"
            RD_PORT="${REDIS_PORT:-6379}"

            cat > .env << ENVEOF
            ENVIRONMENT=production
            DEBUG=false
            SECRET_KEY=${SECRET_KEY}
            UPSTOX_API_KEY=${UPSTOX_API_KEY}
            UPSTOX_API_SECRET=${UPSTOX_API_SECRET}
            UPSTOX_REDIRECT_URI=https://predictionapi.gahfaudio.in/api/v1/auth/callback
            UPSTOX_ACCESS_TOKEN=${UPSTOX_ACCESS_TOKEN}
            POSTGRES_HOST=${PG_HOST}
            POSTGRES_PORT=${PG_PORT}
            POSTGRES_DB=${POSTGRES_DB:-silver_prediction}
            POSTGRES_USER=${POSTGRES_USER:-prediction_user}
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            REDIS_HOST=${RD_HOST}
            REDIS_PORT=${RD_PORT}
            CELERY_BROKER_URL=redis://${RD_HOST}:${RD_PORT}/0
            CELERY_RESULT_BACKEND=redis://${RD_HOST}:${RD_PORT}/0
            API_HOST=127.0.0.1
            API_PORT=8023
            API_DOMAIN=predictionapi.gahfaudio.in
            FRONTEND_URL=https://prediction.gahfaudio.in
            DASHBOARD_DOMAIN=prediction.gahfaudio.in
            MODEL_WEIGHTS_PATH=/home/predictionapi.gahfaudio.in/data/models
            ENVEOF

            # Remove leading whitespace from .env
            sed -i 's/^[[:space:]]*//' .env

            # Copy .env to backend directory as well (systemd runs from there)
            cp .env backend/.env

            # Copy systemd service files
            echo "Setting up systemd service files..."
            cp deploy/systemd/silver-prediction-api.service /etc/systemd/system/
            cp deploy/systemd/silver-prediction-worker.service /etc/systemd/system/ 2>/dev/null || true
            cp deploy/systemd/silver-prediction-scheduler.service /etc/systemd/system/ 2>/dev/null || true

            # Reload systemd and restart services
            echo "Restarting services..."
            systemctl daemon-reload

            # Enable and start API service
            systemctl enable silver-prediction-api
            systemctl restart silver-prediction-api || systemctl start silver-prediction-api

            # Enable and start worker/scheduler (optional, may not be needed initially)
            # systemctl enable silver-prediction-worker
            # systemctl restart silver-prediction-worker || true
            # systemctl enable silver-prediction-scheduler
            # systemctl restart silver-prediction-scheduler || true

            sleep 5
            echo "=== Service Status ==="
            systemctl status silver-prediction-api --no-pager || echo "Service status check failed"

            echo "=== Backend Deployment Complete ==="

  notify:
    name: Notify on Failure
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "Backend deployment failed! Check the workflow logs."
