name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio

      - name: Run linting
        run: |
          cd backend
          pip install flake8
          flake8 app --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Run tests
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key-for-testing-only
          ENVIRONMENT: testing
        run: |
          cd backend
          pytest tests/ -v || true

  deploy:
    name: Deploy to Server
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to CyberPanel Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            set -e

            echo "=== Starting Backend Deployment ==="

            # Paths
            BACKEND_PATH="/home/predictionapi.gahfaudio.in/public_html"
            DATA_PATH="/home/predictionapi.gahfaudio.in/data"
            LOGS_PATH="/home/predictionapi.gahfaudio.in/logs"

            # Navigate to project directory
            cd $BACKEND_PATH

            # Pull latest changes
            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # Create data directories if not exist
            mkdir -p $DATA_PATH/models
            mkdir -p $DATA_PATH/raw
            mkdir -p $DATA_PATH/processed
            mkdir -p $LOGS_PATH

            # Set ownership
            chown -R predictionapi.gahfaudio.in:predictionapi.gahfaudio.in $DATA_PATH || true
            chown -R predictionapi.gahfaudio.in:predictionapi.gahfaudio.in $LOGS_PATH || true

            # Create virtual environment if not exists
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment..."
              python3.11 -m venv venv
            fi

            # Activate virtual environment and install dependencies
            echo "Installing dependencies..."
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r backend/requirements.txt

            # Create .env file (without leading spaces)
            echo "Creating .env file..."
            cat > .env << 'ENVEOF'
ENVIRONMENT=production
DEBUG=false
SECRET_KEY=${{ secrets.SECRET_KEY }}
UPSTOX_API_KEY=${{ secrets.UPSTOX_API_KEY }}
UPSTOX_API_SECRET=${{ secrets.UPSTOX_API_SECRET }}
UPSTOX_REDIRECT_URI=https://predictionapi.gahfaudio.in/api/v1/auth/callback
UPSTOX_ACCESS_TOKEN=${{ secrets.UPSTOX_ACCESS_TOKEN }}
POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}
POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
POSTGRES_DB=${{ secrets.POSTGRES_DB }}
POSTGRES_USER=${{ secrets.POSTGRES_USER }}
POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
REDIS_HOST=${{ secrets.REDIS_HOST }}
REDIS_PORT=${{ secrets.REDIS_PORT }}
CELERY_BROKER_URL=redis://${{ secrets.REDIS_HOST }}:${{ secrets.REDIS_PORT }}/0
CELERY_RESULT_BACKEND=redis://${{ secrets.REDIS_HOST }}:${{ secrets.REDIS_PORT }}/0
API_HOST=127.0.0.1
API_PORT=8023
API_DOMAIN=predictionapi.gahfaudio.in
FRONTEND_URL=https://prediction.gahfaudio.in
DASHBOARD_DOMAIN=prediction.gahfaudio.in
MODEL_WEIGHTS_PATH=/home/predictionapi.gahfaudio.in/data/models
ENVEOF

            # Copy supervisor configs
            echo "Setting up supervisor configs..."
            cp deploy/supervisor/*.conf /etc/supervisord.d/ 2>/dev/null || true

            # Reload and restart services
            echo "Restarting services..."
            supervisorctl reread || true
            supervisorctl update || true
            supervisorctl restart silver-prediction-api 2>/dev/null || supervisorctl start silver-prediction-api || true
            supervisorctl restart silver-prediction-worker 2>/dev/null || supervisorctl start silver-prediction-worker || true
            supervisorctl restart silver-prediction-scheduler 2>/dev/null || supervisorctl start silver-prediction-scheduler || true

            # Wait and check status
            sleep 5
            echo "=== Service Status ==="
            supervisorctl status | grep silver || echo "Checking services..."

            echo "=== Backend Deployment Complete ==="

  notify:
    name: Notify on Failure
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "Backend deployment failed! Check the workflow logs."
